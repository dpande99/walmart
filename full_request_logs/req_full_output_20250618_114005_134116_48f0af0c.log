2025-06-18 11:40:05,134 - main_sequential - INFO - --- CAPTURING ALL OUTPUT for req_id 48f0af0c to: full_request_logs/req_full_output_20250618_114005_134116_48f0af0c.log ---
2025-06-18 11:40:05,136 - api.routes.agent_sequential - INFO - Initializing AgentManager singleton.
2025-06-18 11:40:05,138 - api.routes.agent_sequential - INFO - Console: Received query in agent.py endpoint: give me a boxplot of prices for FOODS_3 in CA stores
2025-06-18 11:40:05,138 - core.agent_manager_sequential - INFO - AgentManager.process_query received query: 'give me a boxplot of prices for FOODS_3 in CA stores'
2025-06-18 11:40:05,138 - core.agent_manager_sequential - INFO - --- XIYAN-SQL ORCHESTRATED WORKFLOW START ---
2025-06-18 11:40:05,246 - core.agents_sequential - INFO - METADATA_AVAILABLE is True. Registering data dictionary tools.
2025-06-18 11:40:05,268 - core.agent_manager_sequential - INFO - [Orchestrator] STAGE 1: Schema Linking
--- STDOUT/STDERR REDIRECTION ACTIVE (ReqID: 48f0af0c, Time: 2025-06-18 11:40:05.134706) ---
instantiated AgentManagerSequential object
created new sequential agents
[33mUserProxy[0m (to SchemaAnalyst):

User Question: 'give me a boxplot of prices for FOODS_3 in CA stores'

--------------------------------------------------------------------------------
[31m
>>>>>>>> USING AUTO REPLY...[0m
2025-06-18 11:40:06,554 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
[33mSchemaAnalyst[0m (to UserProxy):

[32m***** Suggested tool call (call_oaPiYC62wxtkOTeGs9glBJLv): get_data_dictionary_tables *****[0m
Arguments: 
{}
[32m*******************************************************************************************[0m

--------------------------------------------------------------------------------
[35m
>>>>>>>> EXECUTING FUNCTION get_data_dictionary_tables...
Call ID: call_oaPiYC62wxtkOTeGs9glBJLv
Input arguments: {}[0m
2025-06-18 11:40:06,565 - tools.db_tools - WARNING - METADATA SCHEMA (DB_SCHEMAS[1]) is not properly configured. DD tables might not be found.
2025-06-18 11:40:06,566 - tools.db_tools - WARNING - No specific metadata schema configured, attempting to use 'dd_tables' directly.
2025-06-18 11:40:06,566 - tools.db_tools - INFO - Tool: get_data_dictionary_tables - Querying Identifier('dd_tables').
2025-06-18 11:40:06,577 - tools.db_tools - ERROR - Tool: Error in get_data_dictionary_tables querying Identifier('dd_tables'): relation "dd_tables" does not exist
LINE 1: ...ECT "Table", "Priority", "Table Description" FROM "dd_tables...
                                                             ^
Traceback (most recent call last):
  File "/Users/dristipande/Desktop/walmart/tools/db_tools.py", line 277, in get_data_dictionary_tables
    cursor.execute(query)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/dristipande/Desktop/walmart/venv/lib/python3.13/site-packages/psycopg2/extras.py", line 236, in execute
    return super().execute(query, vars)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^
psycopg2.errors.UndefinedTable: relation "dd_tables" does not exist
LINE 1: ...ECT "Table", "Priority", "Table Description" FROM "dd_tables...
                                                             ^

[33mUserProxy[0m (to SchemaAnalyst):

[32m***** Response from calling tool (call_oaPiYC62wxtkOTeGs9glBJLv) *****[0m
[{'error': 'Failed to retrieve from Identifier(\'dd_tables\'): relation "dd_tables" does not exist\nLINE 1: ...ECT "Table", "Priority", "Table Description" FROM "dd_tables...\n                                                             ^\n'}]
[32m**********************************************************************[0m

--------------------------------------------------------------------------------
[31m
>>>>>>>> USING AUTO REPLY...[0m
2025-06-18 11:40:07,984 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
[33mSchemaAnalyst[0m (to UserProxy):

[32m***** Suggested tool call (call_7I01W2kmJh2Ii82x6IijTyx5): get_all_db_objects *****[0m
Arguments: 
{}
[32m***********************************************************************************[0m

--------------------------------------------------------------------------------
[35m
>>>>>>>> EXECUTING FUNCTION get_all_db_objects...
Call ID: call_7I01W2kmJh2Ii82x6IijTyx5
Input arguments: {}[0m
[33mUserProxy[0m (to SchemaAnalyst):

[32m***** Response from calling tool (call_7I01W2kmJh2Ii82x6IijTyx5) *****[0m
{'tables': [{'schema': 'walmart_schema', 'name': 'calendar', 'full_name': 'walmart_schema.calendar'}, {'schema': 'walmart_schema', 'name': 'sales', 'full_name': 'walmart_schema.sales'}, {'schema': 'walmart_schema', 'name': 'sell_prices', 'full_name': 'walmart_schema.sell_prices'}], 'views': [], 'materialized_views': []}
[32m**********************************************************************[0m

--------------------------------------------------------------------------------
[31m
>>>>>>>> USING AUTO REPLY...[0m
2025-06-18 11:40:08,616 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
[33mSchemaAnalyst[0m (to UserProxy):

[32m***** Suggested tool call (call_t2HANfgL7xcfMsnjB6V5abdm): get_all_db_objects *****[0m
Arguments: 
{}
[32m***********************************************************************************[0m

--------------------------------------------------------------------------------
[31m
>>>>>>>> TERMINATING RUN (b0b53328-3772-4ff4-b2c7-28263e769fb3): Maximum turns (3) reached[0m
2025-06-18 11:40:08,645 - core.agent_manager_sequential - ERROR - Failed to parse JSON list with key 'tables': 'NoneType' object has no attribute 'find'. Content was: 'None'
2025-06-18 11:40:08,646 - core.agent_manager_sequential - ERROR - Error in orchestration workflow: Orchestrator could not parse a required response for key: tables
Traceback (most recent call last):
  File "/Users/dristipande/Desktop/walmart/core/agent_manager_sequential.py", line 218, in _parse_json_list
    json_str = self._extract_json_from_string(last_message)
  File "/Users/dristipande/Desktop/walmart/core/agent_manager_sequential.py", line 197, in _extract_json_from_string
    start_brace = text.find('{')
                  ^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'find'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/dristipande/Desktop/walmart/core/agent_manager_sequential.py", line 49, in _orchestrate_workflow
    selected_tables = self._parse_json_list(chat_res_1, 'tables')
  File "/Users/dristipande/Desktop/walmart/core/agent_manager_sequential.py", line 223, in _parse_json_list
    raise ValueError(f"Orchestrator could not parse a required response for key: {key}")
ValueError: Orchestrator could not parse a required response for key: tables
2025-06-18 11:40:08,648 - core.agent_manager_sequential - INFO - AgentManager.process_query finished for query: 'give me a boxplot of prices for FOODS_3 in CA stores'
2025-06-18 11:40:08,648 - api.routes.agent_sequential - INFO - API Endpoint: agent_manager.process_query returned.
2025-06-18 11:40:08,649 - main_sequential - INFO - --- FINISHED CAPTURING OUTPUT for req_id 48f0af0c. File: full_request_logs/req_full_output_20250618_114005_134116_48f0af0c.log ---
--- STDOUT/STDERR REDIRECTION ENDED (ReqID: 48f0af0c, Time: 2025-06-18 11:40:08.649322) ---
