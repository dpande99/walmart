2025-06-18 09:08:26,066 - INFO - Starting M5 data transformation and loading process.
2025-06-18 09:08:26,290 - INFO - Reading source CSV files into memory...
2025-06-18 09:08:28,150 - INFO - All CSV files read successfully.
2025-06-18 09:08:28,150 - INFO - Transforming 'sales_train_evaluation.csv' from wide to long format...
2025-06-18 09:08:39,247 - INFO - Sales data transformed. The new 'sales' table has 18939271 rows (only includes non-zero sales days).
2025-06-18 09:08:39,475 - INFO - Ensuring schema 'walmart_schema' exists...
2025-06-18 09:08:39,478 - INFO - Loading data into table: 'walmart_schema.calendar'...
2025-06-18 09:08:39,681 - ERROR - A critical error occurred. The transaction was rolled back.
Traceback (most recent call last):
  File "/Users/dristipande/Desktop/walmart/venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/dristipande/Desktop/walmart/venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
psycopg2.errors.DependentObjectsStillExist: cannot drop table walmart_schema.calendar because other objects depend on it
DETAIL:  constraint fk_sales_calendar_d on table walmart_schema.sales depends on table walmart_schema.calendar
HINT:  Use DROP ... CASCADE to drop the dependent objects too.


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/dristipande/Desktop/walmart/load_walmart_data.py", line 95, in main
    df.to_sql(
    ~~~~~~~~~^
        name=table_name,
        ^^^^^^^^^^^^^^^^
    ...<5 lines>...
        method='multi'
        ^^^^^^^^^^^^^^
    )
    ^
  File "/Users/dristipande/Desktop/walmart/venv/lib/python3.13/site-packages/pandas/util/_decorators.py", line 333, in wrapper
    return func(*args, **kwargs)
  File "/Users/dristipande/Desktop/walmart/venv/lib/python3.13/site-packages/pandas/core/generic.py", line 3106, in to_sql
    return sql.to_sql(
           ~~~~~~~~~~^
        self,
        ^^^^^
    ...<8 lines>...
        method=method,
        ^^^^^^^^^^^^^^
    )
    ^
  File "/Users/dristipande/Desktop/walmart/venv/lib/python3.13/site-packages/pandas/io/sql.py", line 844, in to_sql
    return pandas_sql.to_sql(
           ~~~~~~~~~~~~~~~~~^
        frame,
        ^^^^^^
    ...<9 lines>...
        **engine_kwargs,
        ^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/dristipande/Desktop/walmart/venv/lib/python3.13/site-packages/pandas/io/sql.py", line 2020, in to_sql
    table = self.prep_table(
        frame=frame,
    ...<5 lines>...
        dtype=dtype,
    )
  File "/Users/dristipande/Desktop/walmart/venv/lib/python3.13/site-packages/pandas/io/sql.py", line 1924, in prep_table
    table.create()
    ~~~~~~~~~~~~^^
  File "/Users/dristipande/Desktop/walmart/venv/lib/python3.13/site-packages/pandas/io/sql.py", line 990, in create
    self.pd_sql.drop_table(self.name, self.schema)
    ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/dristipande/Desktop/walmart/venv/lib/python3.13/site-packages/pandas/io/sql.py", line 2075, in drop_table
    self.get_table(table_name, schema).drop(bind=self.con)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File "/Users/dristipande/Desktop/walmart/venv/lib/python3.13/site-packages/sqlalchemy/sql/schema.py", line 1300, in drop
    bind._run_ddl_visitor(ddl.SchemaDropper, self, checkfirst=checkfirst)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/dristipande/Desktop/walmart/venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 2455, in _run_ddl_visitor
    ).traverse_single(element)
      ~~~~~~~~~~~~~~~^^^^^^^^^
  File "/Users/dristipande/Desktop/walmart/venv/lib/python3.13/site-packages/sqlalchemy/sql/visitors.py", line 664, in traverse_single
    return meth(obj, **kw)
  File "/Users/dristipande/Desktop/walmart/venv/lib/python3.13/site-packages/sqlalchemy/sql/ddl.py", line 1207, in visit_table
    DropTable(table)._invoke_with(self.connection)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "/Users/dristipande/Desktop/walmart/venv/lib/python3.13/site-packages/sqlalchemy/sql/ddl.py", line 321, in _invoke_with
    return bind.execute(self)
           ~~~~~~~~~~~~^^^^^^
  File "/Users/dristipande/Desktop/walmart/venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1415, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "/Users/dristipande/Desktop/walmart/venv/lib/python3.13/site-packages/sqlalchemy/sql/ddl.py", line 187, in _execute_on_connection
    return connection._execute_ddl(
           ~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/dristipande/Desktop/walmart/venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1526, in _execute_ddl
    ret = self._execute_context(
        dialect,
    ...<4 lines>...
        compiled,
    )
  File "/Users/dristipande/Desktop/walmart/venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1842, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/dristipande/Desktop/walmart/venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1982, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/dristipande/Desktop/walmart/venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 2351, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/dristipande/Desktop/walmart/venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1963, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/dristipande/Desktop/walmart/venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py", line 943, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
sqlalchemy.exc.InternalError: (psycopg2.errors.DependentObjectsStillExist) cannot drop table walmart_schema.calendar because other objects depend on it
DETAIL:  constraint fk_sales_calendar_d on table walmart_schema.sales depends on table walmart_schema.calendar
HINT:  Use DROP ... CASCADE to drop the dependent objects too.

[SQL: 
DROP TABLE walmart_schema.calendar]
(Background on this error at: https://sqlalche.me/e/20/2j85)
2025-06-18 09:08:39,697 - INFO - --- SCRIPT FINISHED ---
